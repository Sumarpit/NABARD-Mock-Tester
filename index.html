<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NABARD Exam Tool (PWA)</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --header-bg: #000000;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --accent: #007bff;
            --correct: #2ecc71;
            --wrong: #e74c3c;
            --review-mode: #6c757d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { height: 100vh; width: 100vw; overflow: hidden; background: var(--bg-color); }

        /* --- SCREENS --- */
        .screen { display: none; height: 100%; width: 100%; }
        #exam-screen.active { display: flex; flex-direction: column; } 
        #upload-screen.active, #result-screen.active { display: block; overflow-y: auto; }

        /* --- 1. UPLOAD SCREEN & LIBRARY --- */
        .container-box { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        
        .library-box { background: var(--card-bg); padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        
        .lib-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .toggle-btn { background: #eee; color: #333; padding: 8px 16px; border-radius: 20px; cursor: pointer; border: 1px solid #ccc; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .toggle-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .toggle-btn .icon { font-weight: bold; font-size: 1.1rem; }

        .drop-zone { border: 2px dashed #ccc; background: #fafafa; cursor: pointer; border-radius: 6px; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .drop-zone:hover { border-color: var(--accent); background: #f0f8ff; }
        input[type="file"] { display: none; }

        .drop-zone-large { height: 150px; padding: 30px; margin-bottom: 20px; }
        .drop-zone-large p { font-size: 1.2rem; margin: 0; }
        .drop-zone-large span { font-size: 0.9rem; color: #777; }
        
        .drop-zone-small { height: 120px; border: 2px dashed var(--accent); background: #f8faff; }
        .drop-zone-small p { font-size: 4rem; font-weight: bold; color: var(--accent); margin: 0; line-height: 0.8; padding-bottom: 10px; }
        .drop-zone-small span { display: none; }

        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .file-card { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 6px; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left; height: 120px; display: flex; flex-direction: column; justify-content: center; position: relative;}
        .file-card:hover { transform: translateY(-3px); border-color: var(--accent); }
        .file-card.active { border: 2px solid var(--accent); background: #e3f2fd; }
        .file-card.multi-selected { border: 2px solid var(--accent); background: #e3f2fd; box-shadow: 0 0 0 2px rgba(0,123,255,0.2); }
        .multi-check { position: absolute; bottom: 10px; right: 10px; background: var(--accent); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; display: none; }
        .file-card.multi-selected .multi-check { display: flex; }

        .file-name { font-weight: bold; font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 5px; word-break: break-word; }
        .del-file { position: absolute; top: 5px; right: 5px; color: #aaa; font-size: 1.2rem; line-height: 1; padding: 0 5px; z-index: 5; }
        .del-file:hover { color: var(--wrong); }

        .settings-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        .time-inputs { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .time-box { width: 60px; padding: 10px; text-align: center; font-size: 1.2rem; border: 1px solid #ddd; border-radius: 4px; }
        
        .history-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #666; font-weight: 600; }

        button { cursor: pointer; border: none; padding: 10px 20px; border-radius: 4px; font-size: 14px; transition: 0.2s; color: white; }
        button.primary { background: var(--accent); }
        button.primary:hover { background: #0056b3; }
        button.primary:disabled { background: #ccc; cursor: not-allowed; }
        button.resume { background: #f39c12; margin-left: 10px; display: none; }
        button.retake { background: #27ae60; padding: 6px 12px; font-size: 0.8rem; }
        button.review { background: #6c757d; }
        button.review:hover { background: #5a6268; }
        button.clear { background: transparent; color: #e74c3c; text-decoration: underline; margin-top: 10px; padding: 0; }

        /* --- 2. EXAM HEADER --- */
        header { 
            height: 70px; background: var(--header-bg); color: white; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 30px; width: 100%; flex-shrink: 0; z-index: 2000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        header.review-mode { background: #343a40; border-bottom: 3px solid #ffc107; }
        
        .header-title { font-size: 1.6rem; font-weight: 700; letter-spacing: 1px; white-space: nowrap; text-transform: uppercase; }
        .header-controls { display: flex; align-items: center; gap: 20px; }
        .timer { font-weight: bold; background: #222; color: #00ff00; padding: 8px 16px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 1.4rem; border: 1px solid #444; }
        .timer.critical { background: #e74c3c; color: white; animation: pulse 1s infinite; }
        .timer.review-timer { color: #ffc107; border-color: #ffc107; }
        
        /* --- EXAM LAYOUT --- */
        .exam-layout { display: flex; flex: 1; width: 100%; overflow: hidden; background: #e9ecef; position: relative; }
        
        .pane-passage { flex: 1; background: #fffbf2; padding: 25px; overflow-y: auto; border-right: 1px solid #ddd; font-family: Georgia, serif; line-height: 1.6; display: none; }
        .pane-passage.active { display: block; }
        
        .pane-question { flex: 1.2; background: #fff; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; min-width: 300px; }
        .q-meta { font-size: 0.85rem; color: #777; margin-bottom: 10px; display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .q-text { font-size: 1.15rem; margin-bottom: 20px; line-height: 1.5; font-weight: 500; }
        
        .opt-label { display: flex; align-items: flex-start; padding: 12px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .opt-label:hover { background: #f8f9fa; border-color: #ccc; }
        .opt-label.selected { background: #e3f2fd; border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
        .opt-label input { margin-right: 12px; margin-top: 4px; }

        .sidebar-handle { width: 15px; background: #dcdcdc; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #555; z-index: 10; border-left: 1px solid #ccc; border-right: 1px solid #ccc; }
        .sidebar-handle:hover { background: #ccc; }

        .pane-sidebar { width: 300px; background: #fff; display: flex; flex-direction: column; transition: width 0.3s ease; flex-shrink: 0; }
        .pane-sidebar.collapsed { width: 0; border: none; overflow: hidden; }
        
        .palette-grid { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; align-content: start; }
        .pal-btn { height: 35px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 4px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .pal-btn.ans { background: var(--correct); color: white; border: none; }
        .pal-btn.visit { background: #e74c3c; color: white; border: none; }
        .pal-btn.current { border: 2px solid #333; }

        .conf-box { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; opacity: 0.5; pointer-events: none; }
        .conf-box.active { opacity: 1; pointer-events: auto; background: #e3f2fd; }
        .conf-opts { display: flex; gap: 5px; margin-top: 10px; }
        .c-btn { flex: 1; padding: 6px; font-size: 0.8rem; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; text-align: center; }
        .c-btn.sel { background: #673ab7; color: white; border-color: #5e35b1; }

        /* --- 3. RESULT SCREEN --- */
        .result-container { max-width: 850px; margin: 40px auto; padding-bottom: 50px; }
        .score-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .score-card { background: white; padding: 20px; border-radius: 8px; width: 150px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid #ccc; }
        .score-card.tot { border-color: var(--accent); }
        .score-card.cor { border-color: var(--correct); }
        .score-card.wrg { border-color: var(--wrong); }
        .analysis-section { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 25px; }
        .analysis-section h3 { margin-bottom: 15px; text-align: center; color: #444; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .review-item { background: white; border-left: 5px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
        .review-item.correct { border-left-color: var(--correct); }
        .review-item.wrong { border-left-color: var(--wrong); }
        .txt-green { color: var(--correct); font-weight: bold; }
        .txt-red { color: var(--wrong); font-weight: bold; }

        /* Mobile */
        .mobile-menu { display: none; background: transparent; font-size: 1.5rem; margin-left: 10px; border:none; color: white;}
        @media (max-width: 768px) {
            header { padding: 0 15px; height: 60px; }
            .header-title { font-size: 1rem; }
            .timer { font-size: 1rem; padding: 4px 8px; }
            .pane-passage { height: 35%; border-bottom: 2px solid #ccc; border-right: none; flex: none; }
            .sidebar-handle { display: none; }
            .pane-sidebar { position: fixed; top: 60px; right: -100%; height: calc(100% - 60px); z-index: 2000; width: 85%; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
            .pane-sidebar.open { right: 0; }
            .mobile-menu { display: block; }
            #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; }
            #overlay.active { display: block; }
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="overlay" onclick="closeSidebar()"></div>

<div id="upload-screen" class="screen active">
    <div class="container-box">
        <div class="library-box">
            <div class="lib-controls">
                <h1>NABARD Exam Library</h1>
                <div class="toggle-btn" id="multiToggle" onclick="toggleMultiSelect()">
                    <span class="icon">‚ùë</span> Select Multiple
                </div>
            </div>
            
            <label class="drop-zone drop-zone-large" id="dropZone">
                <p>üìÇ Click to Load JSON Files</p>
                <span>(Drag & Drop supported)</span>
                <input type="file" id="jsonFile" accept=".json" multiple>
            </label>
            
            <div id="file-grid" class="file-grid"></div>
        </div>

        <div class="settings-box">
            <label style="font-weight:bold;">Exam Duration (HH:MM:SS)</label>
            <div class="time-inputs">
                <input type="number" id="hInput" class="time-box" value="00" min="0">
                <span style="font-weight:bold; padding-top:10px;">:</span>
                <input type="number" id="mInput" class="time-box" value="05" min="0" max="59">
                <span style="font-weight:bold; padding-top:10px;">:</span>
                <input type="number" id="sInput" class="time-box" value="00" min="0" max="59">
            </div>
            <button class="primary" id="start-btn" onclick="startExam()" disabled>Select a Test Above</button>
            <button class="resume" id="resume-btn" onclick="resumeExam()">Resume</button>
        </div>

        <div class="history-box">
            <h3 style="text-align:center; margin-bottom:15px;">Recent Results</h3>
            <table id="history-table">
                <thead><tr><th>Test</th><th>Score</th><th>Action</th></tr></thead>
                <tbody id="history-list"></tbody>
            </table>
            <div id="no-history" style="text-align:center; color:#999; margin-top:10px;">No history found.</div>
            <div style="text-align:center;"><button class="clear" onclick="clearHistory()">Clear History</button></div>
        </div>
    </div>
</div>

<div id="exam-screen" class="screen">
    <header id="main-header">
        <div class="header-title" id="exam-title">NABARD Grade A Mock Test</div>
        <div class="header-controls">
            <div class="timer" id="timer">00:00:00</div>
            <button class="mobile-menu" onclick="openSidebar()">‚ò∞</button>
        </div>
    </header>
    
    <div class="exam-layout">
        <div id="pane-passage" class="pane-passage">
            <div style="font-weight:bold; text-decoration:underline; margin-bottom:10px; color:#8a6d3b;">Reading Comprehension</div>
            <div id="passage-content"></div>
        </div>

        <div class="pane-question">
            <div class="q-meta">
                <span><span id="q-sec">Sec</span> | <span id="q-topic">Top</span></span>
                <span>Q. <span id="q-num">1</span></span>
            </div>
            <div class="q-text" id="q-text">Loading...</div>
            <div id="options-box"></div>

            <div class="conf-box" id="conf-box">
                <strong>Confidence Level:</strong>
                <div class="conf-opts">
                    <div class="c-btn" onclick="setConf('100% Sure')">100% Sure</div>
                    <div class="c-btn" onclick="setConf('50:50')">50:50</div>
                    <div class="c-btn" onclick="setConf('Logical')">Logical</div>
                    <div class="c-btn" onclick="setConf('Guess')">Guess</div>
                </div>
            </div>

            <div style="margin-top:auto; padding-top:20px; display:flex; justify-content:space-between;">
                <button onclick="clearRes()" style="background:#e74c3c;">Clear</button>
                <button class="primary" onclick="nextQ()" id="next-btn">Save & Next</button>
            </div>
        </div>

        <div class="sidebar-handle" onclick="toggleSidebar()">‚ñ∂</div>

        <div id="pane-sidebar" class="pane-sidebar">
            <div style="padding:15px; background:#f9f9f9; border-bottom:1px solid #eee;">
                <button class="primary" style="width:100%; background:#27ae60;" onclick="submitExam()">SUBMIT TEST</button>
            </div>
            <div style="padding:10px; font-size:0.8rem; display:flex; gap:10px; flex-wrap:wrap; border-bottom:1px solid #eee;">
                <span style="color:var(--correct)">‚óè Ans</span> <span style="color:#e74c3c">‚óè Unans</span> <span style="border:1px solid #ccc; width:10px; height:10px; display:inline-block;"></span> Visit
            </div>
            <div id="palette" class="palette-grid"></div>
        </div>
    </div>
</div>

<div id="result-screen" class="screen">
    <div class="result-container">
        <div style="text-align:center; margin-bottom:30px;">
            <h1>Analysis Report</h1>
            <p id="res-fname" style="color:#666; margin-bottom:15px;"></p>
            <div class="btn-group">
                <button class="primary" onclick="returnToLibrary()">Back to Library</button>
                <button class="review" id="smart-review-btn" onclick="startSmartReview()" style="display:none; background:#ffc107; color:#333; font-weight:bold;">Smart Review</button>
                <button class="primary" style="background:#27ae60; margin-left:10px;" onclick="downloadRes()">Download HTML</button>
            </div>
        </div>

        <div class="score-row">
            <div class="score-card tot"><h2 id="r-score">0</h2><small>Marks</small></div>
            <div class="score-card cor"><h2 id="r-cor">0</h2><small>Correct</small></div>
            <div class="score-card wrg"><h2 id="r-wrg">0</h2><small>Wrong</small></div>
            <div class="score-card"><h2 id="r-skip">0</h2><small>Skipped</small></div>
        </div>

        <div class="analysis-section">
            <h3>Confidence Analysis</h3>
            <div style="overflow-x:auto;">
                <table id="tbl-conf"><thead><tr><th>Type</th><th>Correct</th><th>Wrong</th><th>Total</th><th>Accuracy</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div class="analysis-section">
            <h3>Topic Analysis</h3>
            <div style="overflow-x:auto;">
                <table id="tbl-topic"><thead><tr><th>Topic</th><th>Total</th><th>Correct</th><th>Wrong</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div class="analysis-section">
            <h3>Detailed Review</h3>
            <div id="review-list"></div>
        </div>
    </div>
</div>

<script>
    const KEY = 'nabard_v25_data';
    const HIST = 'nabard_v25_hist';
    const LIB_KEY = 'nabard_v25_library';
    
    let library = {}, activeFile = '', questions = [], currIdx = 0;
    let responses = {}, confidence = {}, visited = {};
    let timer, seconds = 0;
    
    let isMultiMode = false;
    let selectedFiles = new Set();
    let isReviewMode = false;
    let reviewSet = [];

    // --- PWA LAUNCH HANDLER ---
    if ('launchQueue' in window) {
        window.launchQueue.setConsumer(async (launchParams) => {
            if(!launchParams.files.length) return;
            const fileHandle = launchParams.files[0];
            const file = await fileHandle.getFile();
            // Directly load this file
            loadFiles([file]);
        });
    }

    // --- SERVICE WORKER REGISTRATION ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
        .then(() => console.log('SW Registered'))
        .catch(err => console.log('SW Fail', err));
    }

    window.onload = () => { 
        try { 
            loadLibraryFromStorage(); 
            loadHistory(); 
            checkResume(); 
        } catch(e){ console.error(e); } 
    };

    document.getElementById('jsonFile').onchange = (e) => loadFiles(e.target.files);
    const drop = document.getElementById('dropZone');
    drop.ondragover = e => { e.preventDefault(); drop.style.background='#e1f5fe'; };
    drop.ondragleave = e => { e.preventDefault(); drop.style.background='#fafafa'; };
    drop.ondrop = e => { e.preventDefault(); drop.style.background='#fafafa'; loadFiles(e.dataTransfer.files); };

    function loadLibraryFromStorage() {
        const savedLib = localStorage.getItem(LIB_KEY);
        if(savedLib) { try { library = JSON.parse(savedLib); renderGrid(); } catch(e){} }
    }
    function saveLibraryToStorage() { try { localStorage.setItem(LIB_KEY, JSON.stringify(library)); } catch(e){ alert("Full Storage"); } }

    function loadFiles(files) {
        if(!files.length) return;
        Array.from(files).forEach(f => {
            if(f.name.endsWith('.json')) {
                const r = new FileReader();
                r.onload = e => { 
                    try { library[f.name] = JSON.parse(e.target.result); saveLibraryToStorage(); renderGrid(); } 
                    catch(x){ alert('Invalid JSON: '+f.name); }
                };
                r.readAsText(f);
            }
        });
    }

    function deleteFile(e, fname) {
        e.stopPropagation();
        if(confirm(`Remove "${fname}"?`)) { 
            delete library[fname]; selectedFiles.delete(fname);
            saveLibraryToStorage(); renderGrid(); 
        }
    }

    function toggleMultiSelect() {
        isMultiMode = !isMultiMode;
        selectedFiles.clear();
        document.getElementById('multiToggle').classList.toggle('active');
        renderGrid();
        document.getElementById('start-btn').disabled = true;
        document.getElementById('start-btn').innerText = "Select a Test Above";
    }

    function renderGrid() {
        const grid = document.getElementById('file-grid'); grid.innerHTML = '';
        const dropZone = document.getElementById('dropZone');
        const fileCount = Object.keys(library).length;

        if (fileCount === 0) {
            dropZone.className = 'drop-zone drop-zone-large';
            dropZone.querySelector('p').innerHTML = 'üìÇ Click to Load JSON Files';
            dropZone.querySelector('span').style.display = 'block';
            dropZone.style.display = 'flex'; grid.style.display = 'none'; return;
        } else {
            dropZone.className = 'drop-zone drop-zone-small';
            dropZone.querySelector('p').innerHTML = '+';
            dropZone.querySelector('span').style.display = 'none';
            dropZone.style.display = 'flex'; grid.style.display = 'grid';
        }
        
        Object.keys(library).forEach(name => {
            const d = document.createElement('div'); d.className = 'file-card';
            
            if (isMultiMode) {
                if (selectedFiles.has(name)) d.classList.add('multi-selected');
            } else {
                if (name === activeFile) d.classList.add('active');
            }

            d.innerHTML = `
                <div class="del-file" onclick="deleteFile(event, '${name}')">√ó</div>
                <span class="file-name">${name}</span>
                <small style="color:#777">${library[name].length} Qs</small>
                <div class="multi-check">‚úî</div>
            `;
            
            d.onclick = () => handleCardClick(name);
            grid.appendChild(d);
        });

        if(fileCount > 0) {
            const wrapper = document.createElement('div');
            wrapper.className = 'file-card';
            wrapper.style.cursor = 'pointer';
            wrapper.style.display = 'flex';
            wrapper.style.justifyContent = 'center';
            wrapper.style.alignItems = 'center';
            wrapper.style.background = '#f8faff';
            wrapper.style.border = '2px dashed #007bff';
            wrapper.onclick = () => document.getElementById('jsonFile').click();
            wrapper.innerHTML = `<p style="font-size:4rem; margin:0; color:#007bff; line-height:0.8;">+</p>`;
            grid.appendChild(wrapper);
            dropZone.style.display = 'none'; 
        }
    }

    function handleCardClick(name) {
        if (isMultiMode) {
            if (selectedFiles.has(name)) selectedFiles.delete(name); else selectedFiles.add(name);
            const btn = document.getElementById('start-btn');
            if (selectedFiles.size > 0) {
                let totalQs = 0; selectedFiles.forEach(f => totalQs += library[f].length);
                btn.innerText = `Start Combined (${selectedFiles.size} files, ${totalQs} Qs)`;
                btn.disabled = false;
            } else { btn.innerText = "Select Files"; btn.disabled = true; }
        } else {
            activeFile = name;
            document.getElementById('start-btn').innerText = 'Start: ' + name.replace(/\.json$/i,'');
            document.getElementById('start-btn').disabled = false;
        }
        renderGrid();
    }

    function prepareQuestions(sourceList) {
        let newList = JSON.parse(JSON.stringify(sourceList));
        for (let i = newList.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newList[i], newList[j]] = [newList[j], newList[i]];
        }
        return newList.map(q => {
            let correctText = q.options[q.answer];
            for (let i = q.options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [q.options[i], q.options[j]] = [q.options[j], q.options[i]];
            }
            q.answer = q.options.indexOf(correctText);
            return q;
        });
    }

    function startExam() {
        if(localStorage.getItem(KEY)) if(!confirm("Discard current progress?")) return;
        isReviewMode = false;
        let rawQuestions = [];
        if (isMultiMode) {
            if (selectedFiles.size === 0) return;
            selectedFiles.forEach(f => { if(library[f]) rawQuestions.push(...library[f]); });
            activeFile = "Combined Test";
        } else {
            if(!activeFile || !library[activeFile]) return;
            rawQuestions = library[activeFile];
        }
        questions = prepareQuestions(rawQuestions);
        responses = {}; confidence = {}; visited = {}; currIdx = 0;
        const h = parseInt(document.getElementById('hInput').value)||0;
        const m = parseInt(document.getElementById('mInput').value)||0;
        const s = parseInt(document.getElementById('sInput').value)||0;
        seconds = (h*3600)+(m*60)+s || 300;
        initExamUI();
    }

    function startSmartReview() {
        if(!reviewSet || reviewSet.length === 0) return;
        if(confirm(`Start Review Mode?`)) {
            isReviewMode = true;
            questions = prepareQuestions(reviewSet);
            
            let baseName = activeFile.replace(/\.json$/i, '').replace(/ \(Review\)$/i, '');
            activeFile = baseName + " (Review)";
            
            responses = {}; confidence = {}; visited = {}; currIdx = 0;
            seconds = 0; 
            initExamUI();
        }
    }

    function retakeTest(fname, duration) {
        if(!library[fname] && !fname.startsWith("Combined")) { alert(`File missing.`); return; }
        if(!confirm(`Retake "${fname}"?`)) return;
        isReviewMode = false;
        let rawQuestions = [];
        if(fname.startsWith("Combined")) { alert("Re-select files."); return; } 
        else { rawQuestions = library[fname]; activeFile = fname; }
        questions = prepareQuestions(rawQuestions); 
        seconds = duration || 300; 
        const h = Math.floor(seconds/3600), m = Math.floor((seconds%3600)/60), s = seconds%60;
        document.getElementById('hInput').value = h; document.getElementById('mInput').value = m; document.getElementById('sInput').value = s;
        responses = {}; confidence = {}; visited = {}; currIdx = 0;
        if(localStorage.getItem(KEY)) localStorage.removeItem(KEY);
        initExamUI();
    }

    function initExamUI() {
        document.getElementById('upload-screen').classList.remove('active');
        document.getElementById('result-screen').classList.remove('active');
        document.getElementById('exam-screen').classList.add('active');
        
        let cleanTitle = activeFile.replace(/\.json$/i, ''); 
        document.getElementById('exam-title').innerText = cleanTitle.length > 35 ? cleanTitle.substring(0,35)+'...' : cleanTitle;
        
        const header = document.getElementById('main-header');
        const timerBox = document.getElementById('timer');
        if(isReviewMode) {
            header.classList.add('review-mode');
            timerBox.classList.add('review-timer');
        } else {
            header.classList.remove('review-mode');
            timerBox.classList.remove('review-timer');
        }

        questions.forEach((_,i) => visited[i]=false);
        startTimer(); loadQ(0); saveState();
    }

    function loadQ(i) {
        currIdx = i; visited[i] = true;
        const q = questions[i];
        
        const passDiv = document.getElementById('pane-passage');
        if(q.passage) { passDiv.classList.add('active'); document.getElementById('passage-content').innerHTML = q.passage; }
        else { passDiv.classList.remove('active'); }

        document.getElementById('q-num').innerText = i+1;
        document.getElementById('q-sec').innerText = q.section || '-';
        document.getElementById('q-topic').innerText = q.topic || '-';
        document.getElementById('q-text').innerText = q.question;

        const box = document.getElementById('options-box'); box.innerHTML = '';
        q.options.forEach((opt, idx) => {
            const div = document.createElement('div'); div.className = 'opt-label';
            if(responses[i] === idx) div.classList.add('selected');
            div.onclick = () => { responses[i] = idx; loadQ(i); saveState(); };
            div.innerHTML = `<input type="radio" ${responses[i]===idx?'checked':''}> ${opt}`;
            box.appendChild(div);
        });

        const cBox = document.getElementById('conf-box');
        const cBtns = document.querySelectorAll('.c-btn');
        if(responses[i] !== undefined) {
            cBox.classList.add('active');
            cBtns.forEach(b => {
                b.classList.remove('sel');
                if(b.innerText === confidence[i]) b.classList.add('sel');
            });
        } else {
            cBox.classList.remove('active');
            cBtns.forEach(b => b.classList.remove('sel'));
        }

        const btn = document.getElementById('next-btn');
        if(i === questions.length-1) { btn.innerText = "Submit Test"; btn.style.background = "#e67e22"; }
        else { btn.innerText = "Save & Next"; btn.style.background = "#007bff"; }
        renderPalette();
    }

    function setConf(val) { confidence[currIdx] = val; loadQ(currIdx); saveState(); }
    function clearRes() { delete responses[currIdx]; delete confidence[currIdx]; loadQ(currIdx); saveState(); }
    function nextQ() { if(currIdx < questions.length-1) loadQ(currIdx+1); else submitExam(); }

    function renderPalette() {
        const p = document.getElementById('palette'); p.innerHTML = '';
        questions.forEach((_, i) => {
            const b = document.createElement('div'); b.className = 'pal-btn'; b.innerText = i+1;
            if(i===currIdx) b.classList.add('current');
            if(responses[i]!==undefined) b.classList.add('ans');
            else if(visited[i]) b.classList.add('visit');
            b.onclick = () => { loadQ(i); if(window.innerWidth<=768) closeSidebar(); };
            p.appendChild(b);
        });
    }

    function startTimer() {
        clearInterval(timer);
        timer = setInterval(() => {
            if(isReviewMode) seconds++; else { seconds--; if(seconds<=0) submitExam(true); }
            
            const h = Math.floor(seconds/3600).toString().padStart(2,'0');
            const m = Math.floor((seconds%3600)/60).toString().padStart(2,'0');
            const s = (seconds%60).toString().padStart(2,'0');
            const tEl = document.getElementById('timer');
            tEl.innerText = `${h}:${m}:${s}`;
            
            if(!isReviewMode) seconds < 60 ? tEl.classList.add('critical') : tEl.classList.remove('critical');
        }, 1000);
    }

    function saveState() {
        localStorage.setItem(KEY, JSON.stringify({ library, activeFile, questions, responses, confidence, visited, currIdx, seconds, isReviewMode }));
    }

    function checkResume() { if(localStorage.getItem(KEY)) document.getElementById('resume-btn').style.display = 'inline-block'; }

    function resumeExam() {
        const d = JSON.parse(localStorage.getItem(KEY));
        loadLibraryFromStorage();
        activeFile = d.activeFile; questions = d.questions;
        responses = d.responses; confidence = d.confidence; visited = d.visited;
        currIdx = d.currIdx; seconds = d.seconds; isReviewMode = d.isReviewMode;
        initExamUI();
    }

    function submitExam(force=false) {
        if(!force && !confirm("End Exam?")) return;
        clearInterval(timer); localStorage.removeItem(KEY);

        let score=0, cor=0, wrg=0, skip=0;
        let tStats={}, cStats={ '100% Sure':{c:0,w:0}, '50:50':{c:0,w:0}, 'Logical':{c:0,w:0}, 'Guess':{c:0,w:0} };
        
        reviewSet = [];

        questions.forEach((q, i) => {
            const ans = responses[i]; const conf = confidence[i];
            if(!tStats[q.topic]) tStats[q.topic] = {t:0, c:0, w:0}; tStats[q.topic].t++;
            
            let isWrong = false; let isSkipped = false;

            if(ans === undefined) { skip++; isSkipped=true; } 
            else {
                if(ans === q.answer) {
                    score += 1; cor++; tStats[q.topic].c++;
                    if(conf) cStats[conf].c++;
                } else {
                    score -= 0.25; wrg++; tStats[q.topic].w++;
                    if(conf) cStats[conf].w++;
                    isWrong = true;
                }
            }

            if (isWrong || isSkipped || (conf === 'Guess' || conf === 'Logical')) {
                reviewSet.push(q);
            }
        });

        if(!isReviewMode) {
            const totalDuration = parseInt(document.getElementById('hInput').value)*3600 + 
                                  parseInt(document.getElementById('mInput').value)*60 + 
                                  parseInt(document.getElementById('sInput').value);
            let h = JSON.parse(localStorage.getItem(HIST)||'[]');
            h.unshift({name:activeFile, score:score.toFixed(2), date:new Date().toLocaleDateString(), dur: totalDuration});
            localStorage.setItem(HIST, JSON.stringify(h));
        }

        document.getElementById('exam-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        
        const reviewBtn = document.getElementById('smart-review-btn');
        if(reviewSet.length > 0) {
            reviewBtn.style.display = 'inline-block';
            reviewBtn.innerText = "Smart Review";
        } else {
            reviewBtn.style.display = 'none';
        }

        document.getElementById('res-fname').innerText = activeFile.replace(/\.json$/i, '');
        document.getElementById('r-score').innerText = score.toFixed(2);
        document.getElementById('r-cor').innerText = cor;
        document.getElementById('r-wrg').innerText = wrg;
        document.getElementById('r-skip').innerText = skip;

        const tConf = document.getElementById('tbl-conf').querySelector('tbody'); tConf.innerHTML='';
        Object.keys(cStats).forEach(k => {
            const d = cStats[k], tot = d.c+d.w;
            tConf.innerHTML += `<tr><td>${k}</td><td class="txt-green">${d.c}</td><td class="txt-red">${d.w}</td><td>${tot}</td><td>${tot?Math.round((d.c/tot)*100):0}%</td></tr>`;
        });

        const tTopic = document.getElementById('tbl-topic').querySelector('tbody'); tTopic.innerHTML='';
        Object.keys(tStats).forEach(k => {
            const d = tStats[k];
            tTopic.innerHTML += `<tr><td>${k}</td><td>${d.t}</td><td class="txt-green">${d.c}</td><td class="txt-red">${d.w}</td></tr>`;
        });

        const rev = document.getElementById('review-list'); rev.innerHTML = '';
        questions.forEach((q, i) => {
            const ans = responses[i]; const userConf = confidence[i] || 'None';
            let cls = 'skip', uAns = 'Skipped', status = 'Skipped';
            if(ans !== undefined) {
                if(ans === q.answer) { cls='correct'; uAns=q.options[ans]; status='Correct'; }
                else { cls='wrong'; uAns=q.options[ans]; status='Wrong'; }
            }
            
            rev.innerHTML += `
                <div class="review-item ${cls}">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #eee;">
                        <span style="font-weight:bold;">Q${i+1} (${status})</span>
                        ${ans !== undefined ? `<span style="font-size:0.8rem; background:#333; color:#fff; padding:2px 8px; border-radius:4px;">${userConf}</span>` : ''}
                    </div>
                    <div style="margin-bottom:10px; font-size:1.05rem;">${q.question}</div>
                    <div style="font-size:0.95rem;">
                        You: <b>${uAns}</b> <br>
                        Ans: <span class="txt-green">${q.options[q.answer]}</span>
                    </div>
                    <div style="margin-top:10px; padding:10px; background:#f9f9f9; font-size:0.9rem; border-radius:4px;">
                        <b>Exp:</b> ${q.explanation}
                    </div>
                </div>`;
        });
    }

    function toggleSidebar() { 
        const s = document.getElementById('pane-sidebar'); 
        s.classList.toggle('collapsed');
        document.querySelector('.sidebar-handle').innerText = s.classList.contains('collapsed') ? '‚óÄ' : '‚ñ∂';
    }
    function openSidebar() { document.getElementById('pane-sidebar').classList.add('open'); document.getElementById('overlay').classList.add('active'); }
    function closeSidebar() { document.getElementById('pane-sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('active'); }
    
    function loadHistory() {
        const h = JSON.parse(localStorage.getItem(HIST)||'[]');
        const l = document.getElementById('history-list'); l.innerHTML = '';
        if(h.length) {
            document.getElementById('no-history').style.display='none';
            h.slice(0,10).forEach(x => {
                let displayDate = x.date;
                let displayName = x.name.replace(/\.json$/i, '');
                l.innerHTML += `<tr><td>${displayName}<br><small>${displayDate}</small></td><td><b>${x.score}</b></td><td><button class="retake" onclick="retakeTest('${x.name}', ${x.dur})">Retake</button></td></tr>`;
            });
        }
    }
    function clearHistory() { localStorage.removeItem(HIST); loadHistory(); }
    
    function returnToLibrary() {
        document.getElementById('result-screen').classList.remove('active');
        document.getElementById('upload-screen').classList.add('active');
        renderGrid(); loadHistory();
    }

    function downloadRes() {
        const html = document.getElementById('result-screen').innerHTML;
        const css = document.getElementsByTagName('style')[0].innerText;
        const blob = new Blob([`<html><head><style>${css} body{overflow:visible;} #result-screen{display:block!important;}</style></head><body><div id="result-screen">${html}</div></body></html>`], {type:'text/html'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Result_${activeFile.replace('.json','').replace(/[^a-z0-9]/gi, '_')}.html`; a.click();
    }
</script>
</body>
</html>
